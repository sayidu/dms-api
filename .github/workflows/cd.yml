
# CICD Steps
# 1. Build the image using Docker
# 2. Tag and push the image to ECR
  # tag optional, only on main
# 3. Run Migration, on failure exit.
# 4. Update the ECS task definition(web + worker), if 3 succeeds

name: Deploy to ECR
on:
  pull_request:
    types: [labeled]
  release: 
    types: [published]

## Request access for this to be added to Github secrets
# To do: secrets go into github settings, rotate the secrets the first. 
jobs:
  build:
    name: Build Image
    if: ${{ github.event.label.name == 'deploy' || github.event_name == 'release' }}
    runs-on: ubuntu-latest
    steps:
    - name: Determine Deployment Environment
      id: environment-checks
      if: ${{ startsWith(github.event.release.tag_name, 'stag') }}
      run: |
        echo "GITHUB_SHA_SHORT=staging" >> $GITHUB_ENV
    - name: Confirm that env was set
      id: env-checks
      run: |
        echo "=========="
        echo $GITHUB_SHA_SHORT
        echo "==========sha"
